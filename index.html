<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neon Tap Shooter</title>
  <style>
    html,body{
      margin:0;
      height:100%;
      background:#05070c;
      color:#fff;
      font-family:system-ui,Segoe UI,Roboto,Arial;
    }
    #game{
      display:grid;
      place-items:center;
      height:100vh;
    }
    /* панель с кнопками – сверху, чтобы не мешали игре */
    .ui{
      position:fixed;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      gap:10px;
      z-index:2147483647;
      pointer-events:auto;
    }
    .btn{
      padding:6px 16px;
      border-radius:10px;
      border:1px solid #2b3255;
      background:#10162a;
      color:#d6e0ff;
      cursor:pointer;
      pointer-events:auto;
    }
    canvas{
      position:relative;
      z-index:1;
      pointer-events:auto;
    }
  </style>
</head>
<body>
  <div id="game"></div>

  <div class="ui">
    <button id="sign" class="btn">Sign in</button>
    <button id="share" class="btn">Share</button>
  </div>

  <script type="module">
    import Phaser from "https://esm.sh/phaser@3.70.0";
    import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk";

    // сказать Farcaster'у, что мини-апка готова
    try { sdk?.actions?.ready?.(); } catch {}

    class MainScene extends Phaser.Scene {
      constructor(){
        super("main");
      }
      create(){
        const w = 360;
        const h = 640;
        this.worldWidth = w;
        this.worldHeight = h;

        this.cameras.main.setBackgroundColor("#0b1020");
        this.score = 0;

        // игрок
        const ship = this.add.rectangle(w/2, h-50, 32, 18, 0x3cf4ff)
          .setStrokeStyle(2, 0x2b8cff)
          .setOrigin(0.5);
        this.player = this.physics.add.existing(ship, false);
        this.player.body.setCollideWorldBounds(true);

        // группы
        this.bullets = this.physics.add.group();
        this.enemies = this.physics.add.group();

        // текст счёта
        this.scoreText = this.add.text(12, 48, "Score: 0", {
          fontSize: "16px",
          color: "#9fb3ff"
        }).setDepth(100);

        // управление
        this.cursors = this.input.keyboard.createCursorKeys();
        // тап/клик — стреляем
        this.input.on("pointerdown", () => this.fire());

        // спавн падающих врагов
        this.time.addEvent({
          delay: 900,
          loop: true,
          callback: () => {
            const x = Phaser.Math.Between(20, w - 20);
            // круглый враг
            const enemyGfx = this.add.circle(x, -20, 14, 0xff3366)
              .setStrokeStyle(2, 0xff6a8f);
            const enemy = this.physics.add.existing(enemyGfx, false);
            enemy.body.setVelocityY(110);   // падает вниз
            enemy.body.setCircle(14);
            this.enemies.add(enemyGfx);
          }
        });

        // столкновения пуль и врагов
        this.physics.add.overlap(this.bullets, this.enemies, (bullet, enemy) => {
          bullet.destroy();
          this.makeExplosion(enemy.x, enemy.y);
          enemy.destroy();
          this.score++;
          this.updateScore();
        });

        // если враг упал ниже — уничтожаем
        this.time.addEvent({
          delay: 500,
          loop: true,
          callback: () => {
            this.enemies.getChildren().forEach(e => {
              if (e.y > h + 40) e.destroy();
            });
          }
        });
      }

      fire(){
        // пуля из позиции игрока
        const b = this.add.rectangle(this.player.x, this.player.y - 20, 4, 14, 0x66ccff);
        const bullet = this.physics.add.existing(b, false);
        bullet.body.setVelocityY(-360);
        this.bullets.add(b);
      }

      makeExplosion(x, y){
        const spark = this.add.circle(x, y, 18, 0xff9ab5).setAlpha(0.9);
        this.tweens.add({
          targets: spark,
          alpha: 0,
          scale: 0.2,
          duration: 180,
          onComplete: () => spark.destroy()
        });
      }

      updateScore(){
        this.scoreText.setText("Score: " + this.score);
        // для Share
        window.__score = this.score;
      }

      update(){
        const speed = 220;
        if (this.cursors.left?.isDown){
          this.player.body.setVelocityX(-speed);
        } else if (this.cursors.right?.isDown){
          this.player.body.setVelocityX(speed);
        } else {
          this.player.body.setVelocityX(0);
        }
      }
    }

    // создаём игру
    const game = new Phaser.Game({
      type: Phaser.AUTO,
      width: 360,
      height: 640,
      parent: "game",
      backgroundColor: "#0b1020",
      physics: {
        default: "arcade",
        arcade: { debug: false }
      },
      scene: [MainScene],
    });

    // ==== кнопки Farcaster'а ====
    const signBtn = document.getElementById("sign");
    const shareBtn = document.getElementById("share");

    signBtn.addEventListener("click", async (ev) => {
      ev.stopPropagation();
      try {
        if (!sdk?.auth?.request) {
          signBtn.textContent = "SDK not available";
          return;
        }
        signBtn.textContent = "Signing…";
        await sdk.auth.request();
        const u = await sdk.user.get();
        signBtn.textContent = u?.fid ? "Signed in" : "Not signed";
      } catch (e) {
        console.log(e);
        signBtn.textContent = "Auth error";
      }
    });

    shareBtn.addEventListener("click", async (ev) => {
      ev.stopPropagation();
      try {
        if (!sdk?.actions?.composeCast) {
          shareBtn.textContent = "SDK not available";
          return;
        }
        const sc = window.__score ?? 0;
        await sdk.actions.composeCast({
          text: `I scored ${sc} in Neon Tap Shooter!`,
          url: location.origin
        });
      } catch (e) {
        console.log(e);
        shareBtn.textContent = "Share error";
      }
    });
  </script>
</body>
</html>
