<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neon Tap Shooter</title>
  <style>
    html,body{
      margin:0;
      height:100%;
      background:#05070c;
      color:#fff;
      font-family:system-ui,Segoe UI,Roboto,Arial;
    }
    #game{
      display:grid;
      place-items:center;
      height:100vh;
    }
    /* панель с кнопками — сверху */
    .ui{
      position:fixed;
      left:0;
      right:0;
      top:12px;
      display:flex;
      justify-content:center;
      gap:8px;
      z-index:9999;
      pointer-events:auto;
    }
    .btn{
      padding:8px 14px;
      border-radius:10px;
      border:1px solid #2b3255;
      background:#10162a;
      color:#d6e0ff;
      cursor:pointer;
      pointer-events:auto;
    }
    canvas{
      position:relative;
      z-index:1;
      pointer-events:auto;
    }
  </style>
</head>
<body>
  <div id="game"></div>

  <div class="ui">
    <button id="sign" class="btn">Sign in</button>
    <button id="share" class="btn">Share</button>
  </div>

  <script type="module">
    import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk";
    try { sdk?.actions?.ready?.(); } catch {}

    const signBtn  = document.getElementById("sign");
    const shareBtn = document.getElementById("share");

    // ----- КНОПКИ -----
    signBtn.addEventListener("click", async () => {
      signBtn.textContent = "Signing…";
      try {
        if (sdk?.actions?.signIn) {
          const res = await sdk.actions.signIn({
            nonce: String(Date.now()),
            acceptAuthAddress: true,
          });
          signBtn.textContent = res?.fid ? `FID: ${res.fid}` : "Signed in";
          return;
        }
        if (sdk?.auth?.request) {
          await sdk.auth.request();
          const u = await sdk.user.get();
          signBtn.textContent = u?.fid ? `FID: ${u.fid}` : "Not signed";
          return;
        }
        signBtn.textContent = "SDK not available";
      } catch (e) {
        console.log(e);
        signBtn.textContent = "Sign-in error";
      }
    });

    shareBtn.addEventListener("click", async () => {
      shareBtn.textContent = "Opening…";
      try {
        if (!sdk?.actions?.composeCast) {
          shareBtn.textContent = "SDK not available";
          return;
        }
        const score = window.__score ?? 0;
        await sdk.actions.composeCast({
          text: `I scored ${score} in Neon Tap Shooter!`,
          url: location.origin
        });
        shareBtn.textContent = "Shared";
        setTimeout(() => shareBtn.textContent = "Share", 1200);
      } catch (e) {
        console.log(e);
        shareBtn.textContent = "Share error";
      }
    });

    // ----- ИГРА -----
    (async () => {
      try {
        const PhaserMod = await import("https://esm.sh/phaser@3.70.0");
        const Phaser = PhaserMod.default;

        class MainScene extends Phaser.Scene {
          constructor(){ super("main"); }

          create() {
            const w = 360, h = 640;
            this.cameras.main.setBackgroundColor("#0b1020");
            this.score = 0;

            // игрок
            const ship = this.add.rectangle(w/2, h-40, 26, 16, 0x3cf4ff).setStrokeStyle(2,0x2b8cff);
            this.player = this.physics.add.existing(ship, false);
            this.player.body.setCollideWorldBounds(true);

            // группы
            this.bullets = this.physics.add.group();
            this.enemies = this.physics.add.group();

            // клавиатура (ноут)
            this.cursors = this.input.keyboard.createCursorKeys();

            // тапы (телефон): левая половина — влево, правая — вправо, любой тап — выстрел
            this.input.on("pointerdown", (pointer) => {
              const half = this.scale.width / 2;
              // стреляем
              this.fire();
              // и задаём «направление» на 0.5 секунды
              if (pointer.x < half) {
                this.player.body.setVelocityX(-220);
              } else {
                this.player.body.setVelocityX(220);
              }
              this.time.delayedCall(500, () => {
                this.player.body.setVelocityX(0);
              });
            });

            // спавн врагов
            this.time.addEvent({
              delay: 900,
              loop: true,
              callback: () => {
                const x = Phaser.Math.Between(20, w-20);
                const rect = this.add.rectangle(x, -20, 18, 18, 0xff3366).setStrokeStyle(2,0xff6a8f);
                const enemy = this.physics.add.existing(rect, false);
                enemy.body.setVelocityY(140);
                this.enemies.add(enemy);
              }
            });

            // коллизии
            this.physics.add.overlap(this.bullets, this.enemies, (b,e)=>{
              b.destroy();
              e.destroy();
              this.score++;
              this.events.emit("score:change", this.score);
            });

            // текст
            this.label = this.add.text(10,10,"Score: 0",{fontSize:"16px",color:"#9fb3ff"});
          }

          fire(){
            const bRect = this.add.rectangle(this.player.x, this.player.y-14, 4, 10, 0x66ccff);
            const b = this.physics.add.existing(bRect, false);
            b.body.setVelocityY(-360);
            this.bullets.add(b);
          }

          update(){
            // клавиатура для ноута
            if (this.cursors.left?.isDown) {
              this.player.body.setVelocityX(-220);
            } else if (this.cursors.right?.isDown) {
              this.player.body.setVelocityX(220);
            } else {
              // если палец не жмёт — тормозим
              if (!this.input.activePointer.isDown) {
                this.player.body.setVelocityX(0);
              }
            }
          }
        }

        const game = new Phaser.Game({
          type: Phaser.AUTO,
          width: 360,
          height: 640,
          parent: "game",
          backgroundColor: "#0b1020",
          physics: { default: "arcade", arcade: { debug:false }},
          scene: [MainScene],
        });

        // счёт — в окно, чтобы share мог взять
        const scene = () => game.scene.getScene("main");
        scene().events.on("score:change", (s)=> {
          scene().label.setText("Score: " + s);
          window.__score = s;
        });

      } catch (e) {
        console.log("Phaser failed", e);
      }
    })();
  </script>
</body>
</html>
